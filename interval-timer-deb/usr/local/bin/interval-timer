#!/usr/bin/env python3

import tkinter as tk
from tkinter import font
import threading
import os

# ðŸ“ Percorsi dei file audio
SCRIPT_DIR = "/usr/share/interval-timer"
APPLAUSE_FILE = os.path.join(SCRIPT_DIR, "applausi.mp3")
BELL_FILE = os.path.join(SCRIPT_DIR, "campanella.mp3")

class IntervalTimer:
    def __init__(self, root):
        self.root = root
        self.root.title("Interval Timer")

        # ðŸŽ¨ CONFIGURAZIONE COLORI
        self.bg_color = "#3b4252"
        self.start_btn_color = "#a3be8c"
        self.reset_btn_color = "#bf616a"
        self.settings_btn_color = "#ebcb8b"
        self.btn_text_color = "#3b4252"
        self.start_btn_border_color = "#2e3440"
        self.reset_btn_border_color = "#2e3440"
        self.settings_btn_border_color = "#2e3440"
        self.work_timer_color = "#bf616a"
        self.rest_timer_color = "#a3be8c"

        self.root.configure(bg=self.bg_color)

        # Durate fasi (secondi)
        self.work_time = 45
        self.rest_time = 15

        # Stati iniziali
        self.is_running = False
        self.is_work_phase = True
        self.remaining = self.work_time

        # Font
        self.timer_font = font.Font(family="Helvetica", size=48, weight="bold")

        # Etichetta tempo
        self.label = tk.Label(
            root,
            text=self.format_time(self.remaining),
            font=self.timer_font,
            fg=self.work_timer_color,
            bg=self.bg_color
        )
        self.label.pack(pady=30)

        # Etichetta fase
        self.phase_label = tk.Label(
            root,
            text="Workout",
            font=("Helvetica", 18),
            bg=self.bg_color,
            fg=self.work_timer_color
        )
        self.phase_label.pack()

        # Pulsanti
        button_frame = tk.Frame(root, bg=self.bg_color)
        button_frame.pack(pady=20)

        self.start_button = tk.Button(
            button_frame,
            text="Start",
            command=self.start_timer,
            width=8, height=2,
            bg=self.start_btn_color,
            fg=self.btn_text_color,
            activebackground=self.start_btn_color,
            font=("Helvetica", 16, "bold"),
            bd=3,
            relief="raised",
            highlightbackground=self.start_btn_border_color,
            highlightcolor=self.start_btn_border_color,
            highlightthickness=3
        )
        self.start_button.pack(side="left", padx=10)

        self.settings_button = tk.Button(
            button_frame,
            text="Set",
            command=self.open_settings,
            width=8, height=2,
            bg=self.settings_btn_color,
            fg=self.btn_text_color,
            activebackground=self.settings_btn_color,
            font=("Helvetica", 16, "bold"),
            bd=3,
            relief="raised",
            highlightbackground=self.settings_btn_border_color,
            highlightcolor=self.settings_btn_border_color,
            highlightthickness=3
        )
        self.settings_button.pack(side="left", padx=10)

        self.reset_button = tk.Button(
            button_frame,
            text="Reset",
            command=self.reset_timer,
            width=8, height=2,
            bg=self.reset_btn_color,
            fg=self.btn_text_color,
            activebackground=self.reset_btn_color,
            font=("Helvetica", 16, "bold"),
            bd=3,
            relief="raised",
            highlightbackground=self.reset_btn_border_color,
            highlightcolor=self.reset_btn_border_color,
            highlightthickness=3
        )
        self.reset_button.pack(side="left", padx=10)

    def format_time(self, seconds):
        return f"{seconds // 60:02}:{seconds % 60:02}"

    def play_sound(self, file):
        threading.Thread(
            target=lambda: os.system(f"ffplay -nodisp -autoexit -loglevel quiet '{file}'"),
            daemon=True
        ).start()

    def update_timer(self):
        if self.is_running:
            if self.remaining > 0:
                self.remaining -= 1
                self.label.config(text=self.format_time(self.remaining))
                self.root.after(1000, self.update_timer)
            else:
                if self.is_work_phase:
                    self.play_sound(APPLAUSE_FILE)
                else:
                    self.play_sound(BELL_FILE)

                self.is_work_phase = not self.is_work_phase
                if self.is_work_phase:
                    self.remaining = self.work_time
                    self.label.config(fg=self.work_timer_color)
                    self.phase_label.config(text="Workout", fg=self.work_timer_color)
                else:
                    self.remaining = self.rest_time
                    self.label.config(fg=self.rest_timer_color)
                    self.phase_label.config(text="Rest", fg=self.rest_timer_color)

                self.update_timer()

    def start_timer(self):
        if not self.is_running:
            self.is_running = True
            self.update_timer()

    def reset_timer(self):
        self.is_running = False
        self.is_work_phase = True
        self.remaining = self.work_time
        self.label.config(
            text=self.format_time(self.remaining),
            fg=self.work_timer_color
        )
        self.phase_label.config(
            text="Workout",
            fg=self.work_timer_color
        )

    def open_settings(self):
        settings_window = tk.Toplevel(self.root)
        settings_window.title("Timer Settings")
        settings_window.configure(bg=self.bg_color)
        settings_window.geometry("300x250")
        settings_window.resizable(False, False)

        tk.Label(settings_window, text="Workout (s):", bg=self.bg_color, fg=self.work_timer_color).pack(pady=(15, 5))
        workout_entry = tk.Entry(settings_window, font=("Helvetica", 14))
        workout_entry.insert(0, str(self.work_time))
        workout_entry.pack(pady=5)

        tk.Label(settings_window, text="Rest (s):", bg=self.bg_color, fg=self.rest_timer_color).pack(pady=(15, 5))
        rest_entry = tk.Entry(settings_window, font=("Helvetica", 14))
        rest_entry.insert(0, str(self.rest_time))
        rest_entry.pack(pady=5)

        def confirm_settings():
            try:
                work = int(workout_entry.get())
                rest = int(rest_entry.get())
                if work > 0 and rest > 0:
                    self.work_time = work
                    self.rest_time = rest
                    self.reset_timer()
                    settings_window.destroy()
            except ValueError:
                pass

        tk.Button(
            settings_window,
            text="Confirm",
            command=confirm_settings,
            bg=self.settings_btn_color,
            fg=self.btn_text_color,
            width=12, height=2,
            font=("Helvetica", 14, "bold")
        ).pack(pady=20)


if __name__ == "__main__":
    root = tk.Tk()
    root.resizable(False, False)
    app = IntervalTimer(root)
    root.mainloop()

